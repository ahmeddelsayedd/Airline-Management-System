package AMS;

import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.stage.Stage;
import javafx.geometry.Insets;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import java.sql.*;

/**
 * Employee Dashboard for Pilots and Crew Members
 * Demonstrates: Polymorphism (same dashboard for different employee types)
 */
public class EmployeeDashboard {
    private int userId;
    private String name;
    private String role;
    private Stage stage;
    
    public EmployeeDashboard(int userId, String name, String role) {
        this.userId = userId;
        this.name = name;
        this.role = role;
    }
    
    public void open() {
        stage = new Stage();
        
        TabPane tabPane = new TabPane();
        tabPane.getTabs().addAll(
            createInfoTab(),
            createFlightsTab(),
            createPaycheckTab()
        );
        
        VBox root = new VBox(15);
        root.setPadding(new Insets(20));
        root.setStyle("-fx-background-color: #f5f5f5;");
        
        // Title
        Label title = new Label(role + " Dashboard");
        title.setStyle("-fx-font-size: 24px; -fx-font-weight: bold; -fx-text-fill: #1a237e;");
        
        Label welcome = new Label("Welcome, " + name);
        welcome.setStyle("-fx-font-size: 16px; -fx-text-fill: #666;");
        
        root.getChildren().addAll(title, welcome, tabPane);
        
        Scene scene = new Scene(root, 950, 700);
        stage.setScene(scene);
        stage.setTitle(role + " Dashboard");
        stage.show();
    }
    
    private Tab createInfoTab() {
        Tab tab = new Tab("ğŸ“‹ My Information");
        tab.setClosable(false);
        
        VBox card = createInfoCard();
        card.setPadding(new Insets(20));
        
        tab.setContent(card);
        return tab;
    }
    
    private Tab createFlightsTab() {
        Tab tab = new Tab("âœˆï¸ My Flights");
        tab.setClosable(false);
        
        VBox section = createFlightsSection();
        section.setPadding(new Insets(20));
        
        tab.setContent(section);
        return tab;
    }
    
    private Tab createPaycheckTab() {
        Tab tab = new Tab("ğŸ’° My Paychecks");
        tab.setClosable(false);
        
        VBox content = new VBox(15);
        content.setPadding(new Insets(20));
        
        Label title = new Label("Your Paychecks");
        title.setStyle("-fx-font-size: 18px; -fx-font-weight: bold;");
        
        // Paycheck table
        TableView<ObservableList<String>> table = new TableView<>();
        table.setPrefHeight(350);
        setupPaycheckTable(table);
        loadPaychecks(table);
        
        // Buttons
        Button printBtn = new Button("ğŸ–¨ï¸ Print Selected Paycheck");
        printBtn.setStyle("-fx-background-color: #4CAF50; -fx-text-fill: white; -fx-padding: 10px 20px; -fx-font-weight: bold;");
        
        Button refreshBtn = new Button("ğŸ”„ Refresh");
        refreshBtn.setStyle("-fx-padding: 10px 20px;");
        
        Label statusLabel = new Label();
        
        printBtn.setOnAction(e -> {
            ObservableList<String> selected = table.getSelectionModel().getSelectedItem();
            if (selected == null) {
                statusLabel.setText("âŒ Please select a paycheck to print");
                statusLabel.setStyle("-fx-text-fill: red;");
                return;
            }
            
            int paycheckId = Integer.parseInt(selected.get(0));
            printPaycheck(paycheckId, statusLabel, table);
        });
        
        refreshBtn.setOnAction(e -> loadPaychecks(table));
        
        HBox buttonBox = new HBox(10, printBtn, refreshBtn);
        
        content.getChildren().addAll(title, table, buttonBox, statusLabel);
        tab.setContent(content);
        
        return tab;
    }
    
    private VBox createInfoCard() {
        VBox card = new VBox(10);
        card.setPadding(new Insets(15));
        card.setStyle("-fx-background-color: white; -fx-background-radius: 10px; -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.1), 10, 0, 0, 2);");
        
        Label cardTitle = new Label("ğŸ“‹ Your Information");
        cardTitle.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");
        
        Label infoLabel = new Label();
        infoLabel.setStyle("-fx-font-size: 14px;");
        
        try {
            Connection conn = DBConnection.getConnection();
            String sql;
            
            if (role.equals("PILOT")) {
                sql = "SELECT u.email, u.phone, e.employee_id, e.salary, e.department, p.license_number, p.flight_hours, p.certifications " +
                      "FROM users u " +
                      "JOIN employees e ON u.id = e.id " +
                      "JOIN pilots p ON u.id = p.id " +
                      "WHERE u.id = ?";
            } else {
                sql = "SELECT u.email, u.phone, e.employee_id, e.salary, e.department, c.position, c.languages_spoken " +
                      "FROM users u " +
                      "JOIN employees e ON u.id = e.id " +
                      "JOIN crew_members c ON u.id = c.id " +
                      "WHERE u.id = ?";
            }
            
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            
            if (rs.next()) {
                StringBuilder info = new StringBuilder();
                info.append("Name: ").append(name).append("\n");
                info.append("Employee ID: ").append(rs.getString("employee_id")).append("\n");
                info.append("Email: ").append(rs.getString("email")).append("\n");
                info.append("Phone: ").append(rs.getString("phone")).append("\n");
                info.append("Department: ").append(rs.getString("department")).append("\n");
                info.append("Salary: $").append(String.format("%.2f", rs.getDouble("salary"))).append("\n");
                
                if (role.equals("PILOT")) {
                    info.append("License: ").append(rs.getString("license_number")).append("\n");
                    info.append("Flight Hours: ").append(rs.getInt("flight_hours")).append("\n");
                    info.append("Certifications: ").append(rs.getString("certifications"));
                } else {
                    info.append("Position: ").append(rs.getString("position")).append("\n");
                    info.append("Languages: ").append(rs.getString("languages_spoken"));
                }
                
                infoLabel.setText(info.toString());
            }
            
        } catch (SQLException e) {
            e.printStackTrace();
            infoLabel.setText("Error loading information");
        }
        
        card.getChildren().addAll(cardTitle, infoLabel);
        return card;
    }
    
    private VBox createFlightsSection() {
        VBox section = new VBox(10);
        
        Label sectionTitle = new Label("âœˆï¸ Your Assigned Flights");
        sectionTitle.setStyle("-fx-font-size: 18px; -fx-font-weight: bold;");
        
        TableView<ObservableList<String>> table = new TableView<>();
        table.setPrefHeight(300);
        
        if (role.equals("PILOT")) {
            setupPilotFlightTable(table);
            loadPilotFlights(table);
        } else {
            setupCrewFlightTable(table);
            loadCrewFlights(table);
        }
        
        Button refreshBtn = new Button("ğŸ”„ Refresh");
        refreshBtn.setOnAction(e -> {
            if (role.equals("PILOT")) {
                loadPilotFlights(table);
            } else {
                loadCrewFlights(table);
            }
        });
        
        section.getChildren().addAll(sectionTitle, table, refreshBtn);
        return section;
    }
    
    private void setupPilotFlightTable(TableView<ObservableList<String>> table) {
        String[] columns = {"Flight #", "From", "To", "Date", "Departure", "Arrival", "Aircraft", "Status"};
        for (int i = 0; i < columns.length; i++) {
            final int colIndex = i;
            TableColumn<ObservableList<String>, String> column = new TableColumn<>(columns[i]);
            column.setCellValueFactory(param -> 
                new javafx.beans.property.SimpleStringProperty(param.getValue().get(colIndex)));
            table.getColumns().add(column);
        }
    }
    
    private void setupCrewFlightTable(TableView<ObservableList<String>> table) {
        String[] columns = {"Flight #", "From", "To", "Date", "Departure", "Status", "Pilot"};
        for (int i = 0; i < columns.length; i++) {
            final int colIndex = i;
            TableColumn<ObservableList<String>, String> column = new TableColumn<>(columns[i]);
            column.setCellValueFactory(param -> 
                new javafx.beans.property.SimpleStringProperty(param.getValue().get(colIndex)));
            table.getColumns().add(column);
        }
    }
    
    private void loadPilotFlights(TableView<ObservableList<String>> table) {
        table.getItems().clear();
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT f.flight_number, f.departure_airport, f.arrival_airport, f.flight_date, " +
                        "f.departure_time, f.arrival_time, f.status, a.registration_number " +
                        "FROM flights f " +
                        "LEFT JOIN aircraft a ON f.aircraft_id = a.id " +
                        "WHERE f.pilot_id = ? " +
                        "ORDER BY f.flight_date DESC";
            
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            
            while (rs.next()) {
                ObservableList<String> row = FXCollections.observableArrayList();
                row.add(rs.getString("flight_number"));
                row.add(rs.getString("departure_airport"));
                row.add(rs.getString("arrival_airport"));
                row.add(rs.getString("flight_date"));
                row.add(rs.getString("departure_time"));
                row.add(rs.getString("arrival_time"));
                row.add(rs.getString("registration_number") != null ? rs.getString("registration_number") : "TBA");
                row.add(rs.getString("status"));
                table.getItems().add(row);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    private void loadCrewFlights(TableView<ObservableList<String>> table) {
        table.getItems().clear();
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT f.flight_number, f.departure_airport, f.arrival_airport, f.flight_date, " +
                        "f.departure_time, f.status, u.name as pilot_name " +
                        "FROM flights f " +
                        "JOIN flight_crew fc ON f.id = fc.flight_id " +
                        "LEFT JOIN users u ON f.pilot_id = u.id " +
                        "WHERE fc.crew_member_id = ? " +
                        "ORDER BY f.flight_date DESC";
            
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            
            while (rs.next()) {
                ObservableList<String> row = FXCollections.observableArrayList();
                row.add(rs.getString("flight_number"));
                row.add(rs.getString("departure_airport"));
                row.add(rs.getString("arrival_airport"));
                row.add(rs.getString("flight_date"));
                row.add(rs.getString("departure_time"));
                row.add(rs.getString("status"));
                row.add(rs.getString("pilot_name") != null ? rs.getString("pilot_name") : "TBA");
                table.getItems().add(row);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    private void setupPaycheckTable(TableView<ObservableList<String>> table) {
        String[] columns = {"ID", "Pay Period", "Amount", "Generated On", "Status"};
        for (int i = 0; i < columns.length; i++) {
            final int colIndex = i;
            TableColumn<ObservableList<String>, String> column = new TableColumn<>(columns[i]);
            column.setCellValueFactory(param -> 
                new javafx.beans.property.SimpleStringProperty(param.getValue().get(colIndex)));
            table.getColumns().add(column);
        }
    }
    
    private void loadPaychecks(TableView<ObservableList<String>> table) {
        table.getItems().clear();
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT id, CONCAT(pay_period_start, ' to ', pay_period_end) as period, " +
                        "amount, generated_at, is_printed " +
                        "FROM paychecks WHERE employee_id = ? " +
                        "ORDER BY generated_at DESC";
            
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            
            while (rs.next()) {
                ObservableList<String> row = FXCollections.observableArrayList();
                row.add(rs.getString("id"));
                row.add(rs.getString("period"));
                row.add("$" + String.format("%.2f", rs.getDouble("amount")));
                row.add(rs.getString("generated_at"));
                row.add(rs.getBoolean("is_printed") ? "âœ… Printed" : "â³ Ready to Print");
                table.getItems().add(row);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    private void printPaycheck(int paycheckId, Label statusLabel, TableView<ObservableList<String>> table) {
        try {
            Connection conn = DBConnection.getConnection();
            
            // Get paycheck and employee details
            String sql = "SELECT p.pay_period_start, p.pay_period_end, p.amount, " +
                        "u.name, e.employee_id, e.bank_account, e.salary " +
                        "FROM paychecks p " +
                        "JOIN employees e ON p.employee_id = e.id " +
                        "JOIN users u ON e.id = u.id " +
                        "WHERE p.id = ?";
            
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setInt(1, paycheckId);
            ResultSet rs = ps.executeQuery();
            
            if (rs.next()) {
                String empName = rs.getString("name");
                String empId = rs.getString("employee_id");
                String bankAccount = rs.getString("bank_account");
                double grossSalary = rs.getDouble("salary");
                double netPay = rs.getDouble("amount");
                String startDate = rs.getString("pay_period_start");
                String endDate = rs.getString("pay_period_end");
                
                // File chooser
                javafx.stage.FileChooser fileChooser = new javafx.stage.FileChooser();
                fileChooser.setTitle("Save Paycheck");
                fileChooser.setInitialFileName("Paycheck_" + empId + "_" + System.currentTimeMillis() + ".txt");
                fileChooser.getExtensionFilters().add(
                    new javafx.stage.FileChooser.ExtensionFilter("Text Files", "*.txt")
                );
                
                java.io.File file = fileChooser.showSaveDialog(stage);
                
                if (file != null) {
                    java.io.PrintWriter writer = new java.io.PrintWriter(new java.io.FileWriter(file));
                    
                    writer.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                    writer.println("                  EMPLOYEE PAYCHECK");
                    writer.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                    writer.println();
                    writer.println("  Employee Name: " + empName);
                    writer.println("  Employee ID:   " + empId);
                    writer.println("  Bank Account:  " + bankAccount);
                    writer.println();
                    writer.println("  Pay Period:    " + startDate + " to " + endDate);
                    writer.println();
                    writer.println("  Gross Salary:  $" + String.format("%.2f", grossSalary));
                    writer.println("  Deductions:    $" + String.format("%.2f", grossSalary * 0.15));
                    writer.println("  Net Pay:       $" + String.format("%.2f", netPay));
                    writer.println();
                    writer.println("  Generated:     " + new java.util.Date());
                    writer.println();
                    writer.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                    writer.println("         Thank you for your service!");
                    writer.println("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
                    
                    writer.close();
                    
                    // Mark as printed
                    String updateSql = "UPDATE paychecks SET is_printed = TRUE, file_path = ? WHERE id = ?";
                    PreparedStatement updatePs = conn.prepareStatement(updateSql);
                    updatePs.setString(1, file.getAbsolutePath());
                    updatePs.setInt(2, paycheckId);
                    updatePs.executeUpdate();
                    
                    statusLabel.setText("âœ… Paycheck saved: " + file.getName());
                    statusLabel.setStyle("-fx-text-fill: green; -fx-font-weight: bold;");
                    
                    // Refresh table
                    loadPaychecks(table);
                } else {
                    statusLabel.setText("âš ï¸ Print cancelled");
                    statusLabel.setStyle("-fx-text-fill: orange;");
                }
            }
            
        } catch (Exception e) {
            e.printStackTrace();
            statusLabel.setText("âŒ Error: " + e.getMessage());
            statusLabel.setStyle("-fx-text-fill: red;");
        }
    }
}
