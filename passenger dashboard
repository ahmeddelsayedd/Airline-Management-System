package AMS;

import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.stage.Stage;
import javafx.stage.FileChooser;
import javafx.geometry.Insets;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import java.sql.*;
import java.io.*;
import java.util.*;
import java.time.LocalDate;

/**
 * Passenger Dashboard - VIP Private Jet Creation System
 * Passengers CREATE their own flights + View current flight details
 */
public class PassengerDashboard {
    private int userId;
    private String name;
    private Stage stage;
    private Passenger passenger;
    
    public PassengerDashboard(int userId, String name) {
        this.userId = userId;
        this.name = name;
        loadPassengerObject();
    }
    
    private void loadPassengerObject() {
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT u.name, u.email, u.password, u.phone, p.passport_number, p.nationality " +
                        "FROM users u JOIN passengers p ON u.id = p.id WHERE u.id = ?";
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            
            if (rs.next()) {
                this.passenger = new Passenger(
                    rs.getString("name"),
                    rs.getString("email"),
                    rs.getString("password"),
                    rs.getString("phone"),
                    rs.getString("passport_number"),
                    rs.getString("nationality")
                );
            }
            conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    public void open() {
        stage = new Stage();
        
        TabPane tabPane = new TabPane();
        tabPane.getTabs().addAll(
            createMyFlightTab(),
            createProfileTab()
        );
        
        VBox root = new VBox(10);
        Label title = new Label("VIP Passenger Dashboard - Welcome, " + name);
        title.setStyle("-fx-font-size: 20px; -fx-font-weight: bold;");
        root.getChildren().addAll(title, tabPane);
        root.setPadding(new Insets(15));
        
        Scene scene = new Scene(root, 1000, 700);
        stage.setScene(scene);
        stage.setTitle("Passenger Dashboard");
        stage.show();
    }
    
    // ========== MY FLIGHT TAB (Create or View with FULL DETAILS) ==========
    private Tab createMyFlightTab() {
        Tab tab = new Tab("Book Jet");
        tab.setClosable(false);
        
        VBox content = new VBox(15);
        content.setPadding(new Insets(20));
        
        Label info = new Label();
        content.getChildren().add(info);
        
        try {
            Connection conn = DBConnection.getConnection();
            
            // Check if passenger already created a flight
            String checkSql = "SELECT f.id, f.flight_number, f.departure_airport, f.arrival_airport, " +
                             "f.flight_date, f.departure_time, f.arrival_time, f.status, " +
                             "a.registration_number, a.model, a.manufacturer, " +
                             "b.price, b.booking_date " +
                             "FROM flights f " +
                             "JOIN bookings b ON f.id = b.flight_id " +
                             "LEFT JOIN aircraft a ON f.aircraft_id = a.id " +
                             "WHERE b.user_id = ?";
            
            PreparedStatement checkStmt = conn.prepareStatement(checkSql);
            checkStmt.setInt(1, userId);
            ResultSet rs = checkStmt.executeQuery();
            
            if (rs.next()) {
                // ===== ALREADY HAS A FLIGHT - Show DETAILED info =====
                String flightNo = rs.getString("flight_number");
                String from = rs.getString("departure_airport");
                String to = rs.getString("arrival_airport");
                String date = rs.getString("flight_date");
                String depTime = rs.getString("departure_time");
                String arrTime = rs.getString("arrival_time");
                String status = rs.getString("status");
                String aircraft = rs.getString("registration_number");
                String model = rs.getString("model");
                String manufacturer = rs.getString("manufacturer");
                double price = rs.getDouble("price");
                String bookedOn = rs.getString("booking_date");
                
                // Create detailed info card
                VBox flightCard = new VBox(10);
                flightCard.setPadding(new Insets(20));
                flightCard.setStyle("-fx-background-color: white; -fx-background-radius: 15px; " +
                                   "-fx-border-color: #2196F3; -fx-border-width: 3px; -fx-border-radius: 15px; " +
                                   "-fx-effect: dropshadow(gaussian, rgba(0,0,0,0.2), 10, 0, 0, 3);");
                
                Label cardTitle = new Label("Your Private Jet Flight");
                cardTitle.setStyle("-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #1a237e;");
                
                Separator sep1 = new Separator();
                
                // Flight Info Section
                VBox flightInfo = new VBox(5);
                flightInfo.getChildren().addAll(
                    createInfoLabel("Flight Number:", flightNo, true),
                    createInfoLabel("Route:", from + " ‚Üí " + to, false),
                    createInfoLabel("Date:", date, false),
                    createInfoLabel("Departure:", depTime, false),
                    createInfoLabel("Arrival:", arrTime != null ? arrTime : depTime, false),
                    createInfoLabel("Status:", status, false)
                );
                
                Separator sep2 = new Separator();
                
                // Aircraft Info Section
                VBox aircraftInfo = new VBox(5);
                if (aircraft != null) {
                    aircraftInfo.getChildren().addAll(
                        createInfoLabel("Aircraft:", aircraft, false),
                        createInfoLabel("Model:", manufacturer + " " + model, false)
                    );
                } else {
                    aircraftInfo.getChildren().add(createInfoLabel("üõ©Ô∏è Aircraft:", "Private Jet", false));
                }
                
                Separator sep3 = new Separator();
                
                // Booking Info Section
                VBox bookingInfo = new VBox(5);
                bookingInfo.getChildren().addAll(
                    createInfoLabel("Total Cost:", String.format("$%.2f", price), true),
                    createInfoLabel("Booked On:", bookedOn, false)
                );
                
                flightCard.getChildren().addAll(
                    cardTitle, sep1, flightInfo, sep2, aircraftInfo, sep3, bookingInfo
                );
                
                // Print Ticket Button
                Button printBtn = new Button("Print Boarding Pass");
                printBtn.setStyle("-fx-background-color: #4CAF50; -fx-text-fill: white; " +
                                 "-fx-padding: 12px 30px; -fx-font-weight: bold; -fx-font-size: 14px;");
                
                Label printStatus = new Label();
                
                printBtn.setOnAction(e -> printTicket(flightNo, from, to, date, depTime, price, printStatus));
                
                content.getChildren().addAll(flightCard, printBtn, printStatus);
                
            } else {
                // ===== NO FLIGHT - Create new one =====
                info.setText("Create Your Private Jet Flight");
                info.setStyle("-fx-font-size: 18px; -fx-font-weight: bold;");
                
                Label subtitle = new Label("As a VIP passenger, design your exclusive journey");
                subtitle.setStyle("-fx-font-size: 14px; -fx-text-fill: #666;");
                
                // Origin dropdown
                ComboBox<String> originBox = new ComboBox<>();
                originBox.setPromptText("Departing from");
                originBox.setPrefWidth(350);
                originBox.getItems().addAll(
                    "JFK - New York", "LAX - Los Angeles", "ORD - Chicago", "DFW - Dallas",
                    "ATL - Atlanta", "MIA - Miami", "SFO - San Francisco", "LHR - London",
                    "CDG - Paris", "DXB - Dubai", "SIN - Singapore", "HND - Tokyo",
                    "PEK - Beijing", "FRA - Frankfurt", "AMS - Amsterdam", "BCN - Barcelona",
                    "SYD - Sydney", "YYZ - Toronto", "MEX - Mexico City", "GRU - S√£o Paulo"
                );
                
                // Destination dropdown
                ComboBox<String> destinationBox = new ComboBox<>();
                destinationBox.setPromptText("Flying to");
                destinationBox.setPrefWidth(350);
                destinationBox.getItems().addAll(
                    "JFK - New York", "LAX - Los Angeles", "ORD - Chicago", "DFW - Dallas",
                    "ATL - Atlanta", "MIA - Miami", "SFO - San Francisco", "LHR - London",
                    "CDG - Paris", "DXB - Dubai", "SIN - Singapore", "HND - Tokyo",
                    "PEK - Beijing", "FRA - Frankfurt", "AMS - Amsterdam", "BCN - Barcelona",
                    "SYD - Sydney", "YYZ - Toronto", "MEX - Mexico City", "GRU - S√£o Paulo"
                );
                
                DatePicker datePicker = new DatePicker();
                datePicker.setValue(LocalDate.now());
                datePicker.setPrefWidth(350);
                
                Label timeLabel = new Label("Departure Time:");
                timeLabel.setStyle("-fx-font-weight: bold;");
                
                ComboBox<Integer> hourBox = new ComboBox<>();
                hourBox.setPromptText("Hour");
                hourBox.setPrefWidth(100);
                for (int i = 1; i <= 12; i++) {
                    hourBox.getItems().add(i);
                }
                hourBox.setValue(12);
                
                ComboBox<Integer> minuteBox = new ComboBox<>();
                minuteBox.setPromptText("Minute");
                minuteBox.setPrefWidth(100);
                minuteBox.getItems().addAll(0, 15, 30, 45);
                minuteBox.setValue(0);
                
                ComboBox<String> amPmBox = new ComboBox<>();
                amPmBox.setPrefWidth(100);
                amPmBox.getItems().addAll("AM", "PM");
                amPmBox.setValue("AM");
                
                Button createBtn = new Button("Create My Private Jet Flight");
                createBtn.setStyle("-fx-background-color: #2196F3; -fx-text-fill: white; " +
                                  "-fx-padding: 12px 30px; -fx-font-weight: bold; -fx-font-size: 14px;");
                
                Label statusLabel = new Label();
                
                createBtn.setOnAction(e -> {SoundManager.playClick();
                    Connection freshConn = null;
                    PreparedStatement flightPs = null;
                    PreparedStatement bookingPs = null;
                    
                    try {
                        if (originBox.getValue() == null || destinationBox.getValue() == null) {
                            statusLabel.setText("Please select origin and destination");
                            statusLabel.setStyle("-fx-text-fill: red;");
                            return;
                        }
                        
                        String fromCode = originBox.getValue().substring(0, 3);
                        String toCode = destinationBox.getValue().substring(0, 3);
                        
                        if (fromCode.equals(toCode)) {
                            statusLabel.setText("Origin and destination cannot be the same");
                            statusLabel.setStyle("-fx-text-fill: red;");
                            return;
                        }
                        
                        // GET A FRESH CONNECTION HERE - this is the key fix!
                        freshConn = DBConnection.getConnection();
                        
                        // Generate flight number with the fresh connection
                        String flightNo = generateFlightNumber(freshConn);
                        
                        // Convert time
                        int hour = hourBox.getValue();
                        String amPm = amPmBox.getValue();
                        if (amPm.equals("PM") && hour != 12) hour += 12;
                        else if (amPm.equals("AM") && hour == 12) hour = 0;
                        
                        String flightTime = String.format("%02d:%02d:00", hour, minuteBox.getValue());
                        String flightDate = datePicker.getValue().toString();
                        String deputureTime = String.format("%02d:%02d:00", hour+2, minuteBox.getValue());
   
                        double totalPrice = 5000 ;
                        
                    
                        String flightSql = "INSERT INTO flights (flight_number, departure_airport, arrival_airport, " +
                                          "flight_date, departure_time, arrival_time, available_seats, status) " +
                                          "VALUES (?, ?, ?, ?, ?, ?, 6, 'Scheduled')";
                        flightPs = freshConn.prepareStatement(flightSql, Statement.RETURN_GENERATED_KEYS);
                        flightPs.setString(1, flightNo);
                        flightPs.setString(2, fromCode);
                        flightPs.setString(3, toCode);
                        flightPs.setString(4, flightDate);
                        flightPs.setString(5, flightTime);
                        flightPs.setString(6, deputureTime);
                        flightPs.executeUpdate();
                        
                        ResultSet keys = flightPs.getGeneratedKeys();
                        int flightId = 0;
                        if (keys.next()) {
                            flightId = keys.getInt(1);
                        }
                        
                        // Book the flight
                        String bookingSql = "INSERT INTO bookings (booking_id, user_id, flight_id, seat_number, price) " +
                                           "VALUES (?, ?, ?, 'PRIVATE JET', ?)";
                        bookingPs = freshConn.prepareStatement(bookingSql);
                        
                        // Generate shorter booking ID to fit database column
                        long timestamp = System.currentTimeMillis();
                        String shortTimestamp = String.valueOf(timestamp).substring(7); // Last 6 digits
                        String bookingId = "BKG" + shortTimestamp;
                        
                        bookingPs.setString(1, bookingId);
                        bookingPs.setInt(2, userId);
                        bookingPs.setInt(3, flightId);
                        bookingPs.setDouble(4, totalPrice);
                        bookingPs.executeUpdate();
                        
                        statusLabel.setText(String.format("Flight %s created! Total: $%.2f", flightNo, totalPrice));
                        statusLabel.setStyle("-fx-text-fill: green; -fx-font-weight: bold;");
                        
                        // Reload page to show flight details
                        stage.close();
                        open();
                        
                    } catch (Exception ex) {
                        ex.printStackTrace();
                        statusLabel.setText("Error: " + ex.getMessage());
                        statusLabel.setStyle("-fx-text-fill: red;");
                    } finally {
                        // Properly close resources
                        try {
                            if (bookingPs != null) bookingPs.close();
                            if (flightPs != null) flightPs.close();
                            if (freshConn != null) freshConn.close();
                        } catch (SQLException ex) {
                            ex.printStackTrace();
                        }
                    }
                });
                
                content.getChildren().addAll(
                    subtitle,
                    new Label("Origin:"), originBox,
                    new Label("Destination:"), destinationBox,
                    new Label("Date:"), datePicker,
                    timeLabel,
                    new Label("Hour:"), hourBox,
                    new Label("Minute:"), minuteBox,
                    new Label("AM/PM:"), amPmBox,
                    createBtn, statusLabel
                );
            }
            
            // Close the connection used for checking existing flights
            conn.close();
            
        } catch (SQLException e) {
            e.printStackTrace();
        }
        
        ScrollPane scroll = new ScrollPane(content);
        scroll.setFitToWidth(true);
        tab.setContent(scroll);
        return tab;
    }
    
    // Helper method to create info labels
    private Label createInfoLabel(String label, String value, boolean bold) {
        Label lbl = new Label(label + " " + value);
        if (bold) {
            lbl.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");
        } else {
            lbl.setStyle("-fx-font-size: 14px;");
        }
        return lbl;
    }
    
    private String generateFlightNumber(Connection conn) throws SQLException {
        String flightNo;
        PreparedStatement checkStmt = conn.prepareStatement(
            "SELECT flight_number FROM flights WHERE flight_number = ?"
        );
        
        do {
            int randomNum = (int) (Math.random() * 9000) + 1000;
            flightNo = "VIP" + randomNum;
            checkStmt.setString(1, flightNo);
        } while (checkStmt.executeQuery().next());
        
        checkStmt.close();
        return flightNo;
    }
    
   
    
    private void printTicket(String flightNo, String from, String to, String date, String time, double price, Label statusLabel) {
        try {
            FileChooser fileChooser = new FileChooser();
            fileChooser.setTitle("Save Boarding Pass");
            fileChooser.setInitialFileName("PrivateJet_" + flightNo + ".txt");
            fileChooser.getExtensionFilters().add(
                new FileChooser.ExtensionFilter("Text Files", "*.txt")
            );
            
            File file = fileChooser.showSaveDialog(stage);
            
            if (file != null) {
                PrintWriter writer = new PrintWriter(new FileWriter(file));
                
                writer.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                writer.println("           PRIVATE JET BOARDING PASS");
                writer.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                writer.println();
                writer.println("   EXCLUSIVE VIP SERVICE ");
                writer.println();
                writer.println("  Passenger:    " + passenger.getName());
                writer.println("  Passport:     " + passenger.getPassportNumber());
                writer.println();
                writer.println("  Flight:       " + flightNo);
                writer.println("  From:         " + from);
                writer.println("  To:           " + to);
                writer.println("  Date:         " + date);
                writer.println("  Departure:    " + time);
                writer.println();
                writer.println("  Total Cost:   $" + String.format("%.2f", price));
                writer.println();
                writer.println("  Ô∏è ENTIRE AIRCRAFT RESERVED FOR YOUR PARTY");
                writer.println();
                writer.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                writer.println("        Thank you for choosing our luxury service!");
                writer.println("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                
                writer.close();
                
                statusLabel.setText("Boarding pass saved: " + file.getName());
                statusLabel.setStyle("-fx-text-fill: green;");
            }
        } catch (Exception e) {
            statusLabel.setText("Error: " + e.getMessage());
            statusLabel.setStyle("-fx-text-fill: red;");
        }
    }
    private Tab createProfileTab() {
        Tab tab = new Tab("My Profile");
        tab.setClosable(false);

        VBox content = new VBox(20);
        content.setPadding(new Insets(20));

        Label title = new Label("My Profile");
        title.setStyle("-fx-font-size: 18px; -fx-font-weight: bold;");

        // ===== Passenger Info =====
        VBox infoBox = new VBox(10);
        infoBox.setPadding(new Insets(15));
        infoBox.setStyle("-fx-background-color: white; -fx-background-radius: 10px; " +
                         "-fx-border-color: #ddd; -fx-border-radius: 10px;");

        if (passenger != null) {
            infoBox.getChildren().addAll(
                new Label("Name: " + passenger.getName()),
                new Label("Email: " + passenger.getEmail()),
                new Label("Phone: " + passenger.getPhone()),
                new Label("Passport: " + passenger.getPassportNumber()),
                new Label("Nationality: " + passenger.getNationality())
            );
        }

        content.getChildren().addAll(title, infoBox);
        tab.setContent(new ScrollPane(content));

        return tab;
    }
}
