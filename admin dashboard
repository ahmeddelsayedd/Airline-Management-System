package AMS;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.geometry.Insets;
import javafx.scene.Scene;
import javafx.scene.control.Button;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Label;
import javafx.scene.control.PasswordField;
import javafx.scene.control.ScrollPane;
import javafx.scene.control.Tab;
import javafx.scene.control.TabPane;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;

public class AdminDashboard {
    private int adminId;
    private String adminName;
    private Stage stage;

    public AdminDashboard(int adminId, String adminName) {
        this.adminId = adminId;
        this.adminName = adminName;
    }

    public void open() {
        stage = new Stage();

        TabPane tabPane = new TabPane();
        tabPane.getTabs().addAll(
            createPilotTab(),
            createCrewTab(),
            createPassengerTab(),
            createFlightTab(),
            createPaycheckTab()
        );

        VBox root = new VBox(10);
        Label title = new Label("Admin Dashboard - Welcome, " + adminName);
        title.setStyle("-fx-font-size: 20px; -fx-font-weight: bold;");
        root.getChildren().addAll(title, tabPane);
        root.setPadding(new Insets(15));

        Scene scene = new Scene(root, 1200, 700);
        stage.setScene(scene);
        stage.setTitle("Admin Dashboard");
        stage.show();
    }

    // ========== PILOT MANAGEMENT ==========
    private Tab createPilotTab() {
        Tab tab = new Tab( "Pilots");
        tab.setClosable(false);

        VBox content = new VBox(10);
        content.setPadding(new Insets(15));

        Label title = new Label("Pilot Management");
        title.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        // Form
        TextField nameField = new TextField();
        nameField.setPromptText("Name");
        TextField emailField = new TextField();
        emailField.setPromptText("Email");
        PasswordField passwordField = new PasswordField();
        passwordField.setPromptText("Password");
        TextField phoneField = new TextField();
        phoneField.setPromptText("Phone");

        Button addBtn = new Button("‚ûï Add Pilot");
        addBtn.setStyle("-fx-background-color: #4CAF50; -fx-text-fill: white;");
        Button refreshBtn = new Button("üîÑ Refresh");

        Label statusLabel = new Label();

        TableView<ObservableList<String>> table = new TableView<>();
        table.setPrefHeight(300);

        String[] columns = {"ID", "Name", "Email", "Phone"};
        for (int i = 0; i < columns.length; i++) {
            final int colIndex = i;
            TableColumn<ObservableList<String>, String> column = new TableColumn<>(columns[i]);
            column.setCellValueFactory(param ->
                new javafx.beans.property.SimpleStringProperty(param.getValue().get(colIndex)));
            table.getColumns().add(column);
        }

        addBtn.setOnAction(e -> {
            try {
                Connection conn = DBConnection.getConnection();
                String sql = "INSERT INTO users (name, email, password, phone, role) VALUES (?, ?, ?, ?, 'PILOT')";
                PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
                ps.setString(1, nameField.getText());
                ps.setString(2, emailField.getText());
                ps.setString(3, passwordField.getText());
                ps.setString(4, phoneField.getText());
                ps.executeUpdate();

                ResultSet keys = ps.getGeneratedKeys();
                if (keys.next()) {
                    int userId = keys.getInt(1);
                    String empSql = "INSERT INTO employees (id, employee_id, salary, department) VALUES (?, ?, 80000, 'Flight Operations')";
                    PreparedStatement empPs = conn.prepareStatement(empSql);
                    empPs.setInt(1, userId);
                    empPs.setString(2, "EMP" + userId);
                    empPs.executeUpdate();

                    String pilotSql = "INSERT INTO pilots (id, license_number, flight_hours, certifications) VALUES (?, ?, 0, 'Standard')";
                    PreparedStatement pilotPs = conn.prepareStatement(pilotSql);
                    pilotPs.setInt(1, userId);
                    pilotPs.setString(2, "LIC-" + userId);
                    pilotPs.executeUpdate();
                }

                statusLabel.setText("‚úÖ Pilot added!");
                statusLabel.setStyle("-fx-text-fill: green;");
                refreshPilotTable(table);
                nameField.clear(); emailField.clear(); passwordField.clear(); phoneField.clear();
            } catch (Exception ex) {
                statusLabel.setText("‚ùå Error: " + ex.getMessage());
                statusLabel.setStyle("-fx-text-fill: red;");
            }
        });

        refreshBtn.setOnAction(e -> refreshPilotTable(table));

        content.getChildren().addAll(title, nameField, emailField, passwordField, phoneField,
            new HBox(10, addBtn, refreshBtn), statusLabel, table);

        ScrollPane scroll = new ScrollPane(content);
        scroll.setFitToWidth(true);
        tab.setContent(scroll);
        refreshPilotTable(table);
        return tab;
    }

    private void refreshPilotTable(TableView<ObservableList<String>> table) {
        table.getItems().clear();
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT u.id, u.name, u.email, u.phone FROM users u WHERE u.role = 'PILOT'";
            Statement stmt = conn.createStatement();
            ResultSet rs = stmt.executeQuery(sql);

            while (rs.next()) {
                ObservableList<String> row = FXCollections.observableArrayList();
                row.add(rs.getString("id"));
                row.add(rs.getString("name"));
                row.add(rs.getString("email"));
                row.add(rs.getString("phone"));
                table.getItems().add(row);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // ========== CREW MANAGEMENT ==========
    private Tab createCrewTab() {
        Tab tab = new Tab("üë• Crew");
        tab.setClosable(false);

        VBox content = new VBox(10);
        content.setPadding(new Insets(15));

        Label title = new Label("Crew Member Management");
        title.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        TextField nameField = new TextField();
        nameField.setPromptText("Name");
        TextField emailField = new TextField();
        emailField.setPromptText("Email");
        PasswordField passwordField = new PasswordField();
        passwordField.setPromptText("Password");
        TextField phoneField = new TextField();
        phoneField.setPromptText("Phone");

        Button addBtn = new Button("‚ûï Add Crew Member");
        addBtn.setStyle("-fx-background-color: #4CAF50; -fx-text-fill: white;");
        Button refreshBtn = new Button("üîÑ Refresh");

        Label statusLabel = new Label();

        TableView<ObservableList<String>> table = new TableView<>();
        table.setPrefHeight(300);

        String[] columns = {"ID", "Name", "Email", "Phone"};
        for (int i = 0; i < columns.length; i++) {
            final int colIndex = i;
            TableColumn<ObservableList<String>, String> column = new TableColumn<>(columns[i]);
            column.setCellValueFactory(param ->
                new javafx.beans.property.SimpleStringProperty(param.getValue().get(colIndex)));
            table.getColumns().add(column);
        }

        addBtn.setOnAction(e -> {
            try {
                Connection conn = DBConnection.getConnection();
                String sql = "INSERT INTO users (name, email, password, phone, role) VALUES (?, ?, ?, ?, 'CREW')";
                PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
                ps.setString(1, nameField.getText());
                ps.setString(2, emailField.getText());
                ps.setString(3, passwordField.getText());
                ps.setString(4, phoneField.getText());
                ps.executeUpdate();

                ResultSet keys = ps.getGeneratedKeys();
                if (keys.next()) {
                    int userId = keys.getInt(1);
                    String empSql = "INSERT INTO employees (id, employee_id, salary, department) VALUES (?, ?, 45000, 'Cabin Crew')";
                    PreparedStatement empPs = conn.prepareStatement(empSql);
                    empPs.setInt(1, userId);
                    empPs.setString(2, "EMP" + userId);
                    empPs.executeUpdate();

                    String crewSql = "INSERT INTO crew_members (id, position, languages_spoken) VALUES (?, 'Flight Attendant', 'English')";
                    PreparedStatement crewPs = conn.prepareStatement(crewSql);
                    crewPs.setInt(1, userId);
                    crewPs.executeUpdate();
                }

                statusLabel.setText("‚úÖ Crew member added!");
                statusLabel.setStyle("-fx-text-fill: green;");
                refreshCrewTable(table);
                nameField.clear(); emailField.clear(); passwordField.clear(); phoneField.clear();
            } catch (Exception ex) {
                statusLabel.setText("‚ùå Error: " + ex.getMessage());
                statusLabel.setStyle("-fx-text-fill: red;");
            }
        });

        refreshBtn.setOnAction(e -> refreshCrewTable(table));

        content.getChildren().addAll(title, nameField, emailField, passwordField, phoneField,
            new HBox(10, addBtn, refreshBtn), statusLabel, table);

        ScrollPane scroll = new ScrollPane(content);
        scroll.setFitToWidth(true);
        tab.setContent(scroll);
        refreshCrewTable(table);
        return tab;
    }

    private void refreshCrewTable(TableView<ObservableList<String>> table) {
        table.getItems().clear();
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT u.id, u.name, u.email, u.phone FROM users u WHERE u.role = 'CREW'";
            Statement stmt = conn.createStatement();
            ResultSet rs = stmt.executeQuery(sql);

            while (rs.next()) {
                ObservableList<String> row = FXCollections.observableArrayList();
                row.add(rs.getString("id"));
                row.add(rs.getString("name"));
                row.add(rs.getString("email"));
                row.add(rs.getString("phone"));
                table.getItems().add(row);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // ========== PASSENGER MANAGEMENT ==========
    private Tab createPassengerTab() {
        Tab tab = new Tab("üß≥ Passengers");
        tab.setClosable(false);

        VBox content = new VBox(10);
        content.setPadding(new Insets(15));

        Label title = new Label("Passenger Management");
        title.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        TextField nameField = new TextField();
        nameField.setPromptText("Name");
        TextField emailField = new TextField();
        emailField.setPromptText("Email");
        PasswordField passwordField = new PasswordField();
        passwordField.setPromptText("Password");
        TextField phoneField = new TextField();
        phoneField.setPromptText("Phone");
        TextField passportField = new TextField();
        passportField.setPromptText("Passport Number");
        TextField nationalityField = new TextField();
        nationalityField.setPromptText("Nationality");

        Button addBtn = new Button("‚ûï Add Passenger");
        addBtn.setStyle("-fx-background-color: #4CAF50; -fx-text-fill: white;");
        Button refreshBtn = new Button("üîÑ Refresh");

        Label statusLabel = new Label();

        TableView<ObservableList<String>> table = new TableView<>();
        table.setPrefHeight(250);

        String[] columns = {"ID", "Name", "Email", "Passport", "Nationality"};
        for (int i = 0; i < columns.length; i++) {
            final int colIndex = i;
            TableColumn<ObservableList<String>, String> column = new TableColumn<>(columns[i]);
            column.setCellValueFactory(param ->
                new javafx.beans.property.SimpleStringProperty(param.getValue().get(colIndex)));
            table.getColumns().add(column);
        }

        addBtn.setOnAction(e -> {
            try {
                Connection conn = DBConnection.getConnection();
                String sql = "INSERT INTO users (name, email, password, phone, role) VALUES (?, ?, ?, ?, 'PASSENGER')";
                PreparedStatement ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
                ps.setString(1, nameField.getText());
                ps.setString(2, emailField.getText());
                ps.setString(3, passwordField.getText());
                ps.setString(4, phoneField.getText());
                ps.executeUpdate();

                ResultSet keys = ps.getGeneratedKeys();
                if (keys.next()) {
                    int userId = keys.getInt(1);
                    String passSql = "INSERT INTO passengers (id, passport_number, nationality) VALUES (?, ?, ?)";
                    PreparedStatement passPs = conn.prepareStatement(passSql);
                    passPs.setInt(1, userId);
                    passPs.setString(2, passportField.getText());
                    passPs.setString(3, nationalityField.getText());
                    passPs.executeUpdate();
                }

                statusLabel.setText("‚úÖ Passenger added!");
                statusLabel.setStyle("-fx-text-fill: green;");
                refreshPassengerTable(table);
                nameField.clear(); emailField.clear(); passwordField.clear();
                phoneField.clear(); passportField.clear(); nationalityField.clear();
            } catch (Exception ex) {
                statusLabel.setText("‚ùå Error: " + ex.getMessage());
                statusLabel.setStyle("-fx-text-fill: red;");
            }
        });

        refreshBtn.setOnAction(e -> refreshPassengerTable(table));

        content.getChildren().addAll(title, nameField, emailField, passwordField, phoneField,
            passportField, nationalityField, new HBox(10, addBtn, refreshBtn), statusLabel, table);

        ScrollPane scroll = new ScrollPane(content);
        scroll.setFitToWidth(true);
        tab.setContent(scroll);
        refreshPassengerTable(table);
        return tab;
    }

    private void refreshPassengerTable(TableView<ObservableList<String>> table) {
        table.getItems().clear();
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT u.id, u.name, u.email, p.passport_number, p.nationality " +
                        "FROM users u JOIN passengers p ON u.id = p.id";
            Statement stmt = conn.createStatement();
            ResultSet rs = stmt.executeQuery(sql);

            while (rs.next()) {
                ObservableList<String> row = FXCollections.observableArrayList();
                row.add(rs.getString("id"));
                row.add(rs.getString("name"));
                row.add(rs.getString("email"));
                row.add(rs.getString("passport_number"));
                row.add(rs.getString("nationality"));
                table.getItems().add(row);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // ========== FLIGHT TAB (View Created Flights) ==========
    private Tab createFlightTab() {
        Tab tab = new Tab("‚úàÔ∏è Flights");
        tab.setClosable(false);

        VBox content = new VBox(15);
        content.setPadding(new Insets(15));

        Label title = new Label("All Created Flights");
        title.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        TableView<ObservableList<String>> table = new TableView<>();
        table.setPrefHeight(400);

        String[] columns = {"Flight #", "From", "To", "Date", "Time", "Status"};
        for (int i = 0; i < columns.length; i++) {
            final int colIndex = i;
            TableColumn<ObservableList<String>, String> column = new TableColumn<>(columns[i]);
            column.setCellValueFactory(param ->
                new javafx.beans.property.SimpleStringProperty(param.getValue().get(colIndex)));
            table.getColumns().add(column);
        }

        Button refreshBtn = new Button("üîÑ Refresh");
        refreshBtn.setOnAction(e -> refreshFlightTable(table));

        content.getChildren().addAll(title, table, refreshBtn);
        tab.setContent(content);
        refreshFlightTable(table);
        return tab;
    }

    private void refreshFlightTable(TableView<ObservableList<String>> table) {
        table.getItems().clear();
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT flight_number, departure_airport, arrival_airport, flight_date, departure_time, status " +
                        "FROM flights ORDER BY flight_date DESC";
            Statement stmt = conn.createStatement();
            ResultSet rs = stmt.executeQuery(sql);

            while (rs.next()) {
                ObservableList<String> row = FXCollections.observableArrayList();
                row.add(rs.getString("flight_number"));
                row.add(rs.getString("departure_airport"));
                row.add(rs.getString("arrival_airport"));
                row.add(rs.getString("flight_date"));
                row.add(rs.getString("departure_time"));
                row.add(rs.getString("status"));
                table.getItems().add(row);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    // ========== PAYCHECK TAB ==========
    private Tab createPaycheckTab() {
        Tab tab = new Tab("üí∞ Paychecks");
        tab.setClosable(false);

        VBox content = new VBox(15);
        content.setPadding(new Insets(15));

        Label title = new Label("Generate Employee Paychecks");
        title.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        ComboBox<String> employeeBox = new ComboBox<>();
        employeeBox.setPromptText("Select Employee");
        employeeBox.setPrefWidth(400);
        loadEmployees(employeeBox);

        Button generateBtn = new Button("üìÑ Generate Paycheck");
        generateBtn.setStyle("-fx-background-color: #4CAF50; -fx-text-fill: white; -fx-padding: 10px;");

        Label statusLabel = new Label();

        generateBtn.setOnAction(e -> {
            if (employeeBox.getValue() == null) {
                statusLabel.setText("‚ùå Select an employee");
                statusLabel.setStyle("-fx-text-fill: red;");
                return;
            }

            try {
                int empId = Integer.parseInt(employeeBox.getValue().split(" - ")[0]);
                generatePaycheck(empId, statusLabel);
            } catch (Exception ex) {
                statusLabel.setText("‚ùå Error: " + ex.getMessage());
                statusLabel.setStyle("-fx-text-fill: red;");
            }
        });

        content.getChildren().addAll(title, employeeBox, generateBtn, statusLabel);
        tab.setContent(content);
        return tab;
    }

    private void loadEmployees(ComboBox<String> box) {
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT u.id, u.name, e.employee_id FROM users u JOIN employees e ON u.id = e.id";
            Statement stmt = conn.createStatement();
            ResultSet rs = stmt.executeQuery(sql);

            while (rs.next()) {
                box.getItems().add(rs.getInt("id") + " - " + rs.getString("name") + " (" + rs.getString("employee_id") + ")");
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void generatePaycheck(int empId, Label statusLabel) {
        try {
            Connection conn = DBConnection.getConnection();
            String sql = "SELECT u.name, e.salary FROM users u JOIN employees e ON u.id = e.id WHERE u.id = ?";
            PreparedStatement ps = conn.prepareStatement(sql);
            ps.setInt(1, empId);
            ResultSet rs = ps.executeQuery();

            if (rs.next()) {
                double netPay = rs.getDouble("salary") * 0.85;

                String insertSql = "INSERT INTO paychecks (employee_id, pay_period_start, pay_period_end, amount, is_printed) " +
                                  "VALUES (?, CURDATE() - INTERVAL 1 MONTH, CURDATE(), ?, FALSE)";
                PreparedStatement insertPs = conn.prepareStatement(insertSql);
                insertPs.setInt(1, empId);
                insertPs.setDouble(2, netPay);
                insertPs.executeUpdate();

                statusLabel.setText("‚úÖ Paycheck generated for " + rs.getString("name"));
                statusLabel.setStyle("-fx-text-fill: green;");
            }
        } catch (Exception e) {
            e.printStackTrace();
            statusLabel.setText("‚ùå Error: " + e.getMessage());
            statusLabel.setStyle("-fx-text-fill: red;");
        }
    }
}
